import fs from 'fs'
import path from 'path'
import { Usuario } from '../types/usuario'
import { Adm } from '../types/adm'
import { Requisicao } from '../types/requisicao'

const DATA_FILE = path.join(__dirname, '../../data/dados.json')

export interface DadosGlobais {
  usuarios: Record<number, Usuario>
  numerosDisponiveis: string[]
  vendasLog: any[]
  logTransacoes: any[]
  adms: Record<number, Adm>
  requisicoesRecarga: Record<string, Requisicao>
  solicitacoesAfiliado: Record<number, any>
  tickets: Record<string, any>
  configInterface: any
  configSistema: any
}

let dadosCache: DadosGlobais = {
  usuarios: {},
  numerosDisponiveis: [],
  vendasLog: [],
  logTransacoes: [],
  adms: {},
  requisicoesRecarga: {},
  solicitacoesAfiliado: {},
  tickets: {},
  configInterface: {},
  configSistema: {}
}

export function carregarDados(): DadosGlobais {
  try {
    if (fs.existsSync(DATA_FILE)) {
      const data = fs.readFileSync(DATA_FILE, 'utf-8')
      dadosCache = JSON.parse(data)
      console.log('✅ Dados carregados com sucesso')
    } else {
      console.log('⚠️ Arquivo dados.json não encontrado, criando novo')
      salvarDados()
    }
  } catch (error) {
    console.error('❌ Erro ao carregar dados:', error)
  }
  return dadosCache
}

export function salvarDados(): void {
  try {
    fs.mkdirSync(path.dirname(DATA_FILE), { recursive: true })
    fs.writeFileSync(DATA_FILE, JSON.stringify(dadosCache, null, 2), 'utf-8')
    console.log('✅ Dados salvos com sucesso')
  } catch (error) {
    console.error('❌ Erro ao salvar dados:', error)
  }
}

// Getters e setters
export const getUsuarios = () => dadosCache.usuarios
export const getNumerosDisponiveis = () => dadosCache.numerosDisponiveis
export const getAdms = () => dadosCache.adms
export const getRequisicoesRecarga = () => dadosCache.requisicoesRecarga
export const getConfigSistema = () => dadosCache.configSistema
export const getConfigInterface = () => dadosCache.configInterface

export const setUsuarios = (usuarios: any) => { dadosCache.usuarios = usuarios; salvarDados() }
export const setNumerosDisponiveis = (numeros: any) => { dadosCache.numerosDisponiveis = numeros; salvarDados() }
export const setAdms = (adms: any) => { dadosCache.adms = adms; salvarDados() }
export const setRequisicoesRecarga = (reqs: any) => { dadosCache.requisicoesRecarga = reqs; salvarDados() }
export const setConfigSistema = (config: any) => { dadosCache.configSistema = config; salvarDados() }
export const setConfigInterface = (config: any) => { dadosCache.configInterface = config; salvarDados() }